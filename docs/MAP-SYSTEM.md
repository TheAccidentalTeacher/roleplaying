# Map System ‚Äî Full Design Specification
**AI RPG Project** | Design Docs

---

## THE PHILOSOPHY: Maps as Living Artifacts

In a real TTRPG, the map is **the physical object that makes the world real**. The DM reveals a hand-drawn world map. Players trace their journey with a finger. The dungeon gets uncovered room by room. The tactical grid mat goes down on the table ‚Äî suddenly this is *real*, there are bodies in these squares, the door is *right there*.

This game replicates every layer of that experience. Maps are not UI chrome. They are **in-world artifacts** that your character actually possesses. A sailor's map. A dungeon sketch scratched on a wall. A city plan purchased from a merchant guild. A tactical grid drawn in chalk on stone. They look like they came from the world.

> **The rule**: Every map has a story. Who made this? When? What's wrong with it?

---

## The Five Map Layers

Every world has five spatial scales. Each is generated differently, looks different, and serves different gameplay purposes.

```
LAYER 1: THE WORLD MAP
   The full world ‚Äî continents, oceans, kingdoms, mountain ranges
   Scale: the entire world generation area
   Generated: once, at world creation alongside the WorldRecord
   TTRPG analog: The big parchment map on the DM's wall

LAYER 2: REGIONAL MAP
   A specific region ‚Äî province, island, valley, sector
   Scale: one kingdom or wilderness area
   Generated: on first visit, consistent with world map
   TTRPG analog: The map the party buys from the cartographer's guild

LAYER 3: LOCATION MAP
   A specific named place ‚Äî town, city, dungeon, fortress, temple
   Scale: one physical site you can walk through
   Generated: on first visit, consistent with regional map
   TTRPG analog: The hand-drawn town sketch the DM shows you

LAYER 4: AREA MAP (Dungeon/Building)
   Interior of a structure ‚Äî dungeon levels, building floors, cave systems
   Scale: one interior space with rooms and connections
   Generated: on entry, room-by-room fog-of-war reveal
   TTRPG analog: The grid mat unveiled room by room

LAYER 5: TACTICAL MAP (Combat)
   The immediate combat zone ‚Äî battlefield, arena, room
   Scale: a single encounter space (~30x30 to 100x100 ft)
   Generated: at combat start, full tactical detail
   TTRPG analog: The dry-erase grid with minis on it
```

---

## LAYER 1: World Map

### What It Contains

The World Map is generated by Claude Opus as part of World Genesis. It is a **geographic description** converted into a visual artifact.

**For Fantasy worlds** ‚Äî looks like a hand-drawn cartographic map:
- Coastlines with weathered, uneven edges
- Mountain ranges drawn as classic TTRPG symbols (small triangular peaks)
- Forests as tree cluster glyphs
- Rivers flowing from mountains to seas
- Cities marked with castle/tower icons
- Region names in an ornate serif font
- Compass rose
- Optional: decorative sea creatures in the ocean

**For Sci-Fi worlds** ‚Äî looks like a stellar cartography chart or sector map:
- Grid overlay with coordinate labels
- Star systems as nodes with connection lines (hyperspace routes)
- Faction zones shown as colored territories
- Hazard zones (debris fields, anomalies)
- Station/colony icons
- Cold blueprint aesthetic

**For Horror worlds** ‚Äî distorted, uncertain, paranoid:
- Locations that don't quite connect right
- Some regions labeled with question marks or void
- Handwriting that gets increasingly erratic at the edges
- Stains and damage as if the map has been through things
- Missing sections (someone tore out a piece)

**For Post-Apocalypse worlds** ‚Äî the ruins of an old map:
- Pre-war infrastructure visible (old highways, city ruins)
- Radiation zones, dead zones, settlement refugees
- Graffiti and annotations added by survivors
- Damaged, taped-together photocopy aesthetic

### Data Structure

```typescript
interface WorldMap {
  worldId: string

  // Claude-generated geographic description (the input to rendering)
  geographyDescription: GeographyData

  // Rendered map image
  imageUrl: string            // Stored in Supabase Storage
  svgData?: string            // If rendered as SVG (allows interaction)
  style: MapStyle             // 'fantasy' | 'scifi' | 'horror' | 'postapoc' | 'mythological' | 'modern'

  // Revealed locations (fog of war)
  revealedLocations: string[] // Location IDs that have been visited/named
  knownLocations: string[]    // Locations known but not visited (rumors, maps bought)
  unknownZones: string[]      // Regions not yet on the map

  // Player annotations
  playerNotes: MapAnnotation[]  // What the player has written on their map
  questMarkers: QuestMarker[]   // Active quest locations marked

  // Meta
  createdAt: Date
  lastUpdatedAt: Date
  updateCount: number         // How many times new locations were added
}

interface GeographyData {
  // Populated by Claude during World Genesis
  worldName: string
  continents: Continent[]
  oceans: Ocean[]
  majorMountainRanges: string[]
  majorRivers: string[]
  climate: string             // "temperate with harsh northern winters", etc.
  regions: Region[]           // Named areas with distinct character
  startingRegion: string      // Where the character begins
}

interface Region {
  id: string
  name: string
  description: string         // What makes this region distinctive
  controlledBy?: string       // Faction, if applicable
  dangerLevel: 1 | 2 | 3 | 4 | 5
  terrain: string             // "dense forest", "volcanic wasteland", etc.
  knownLocations: LocationSeed[]
  mapPosition: { x: number; y: number }  // Normalized 0-1 coordinates
}
```

### Generation Approach

**World Map rendering uses one of three methods, chosen based on world type:**

#### Method A: AI Image Generation (Highest Quality)
Send Claude's GeographyData to `gpt-image-1` with a detailed style prompt:

```typescript
const worldMapPrompt = (world: WorldRecord): string => {
  const styleGuide = {
    fantasy: "hand-drawn antique cartographic map, aged parchment texture, ink illustration, Tolkien/D&D style with mountain symbols, tree glyphs, compass rose, castle icons, ornate lettering",
    scifi: "stellar cartography chart, dark background with glowing blue/cyan grid lines, star system nodes connected by route lines, colony icons, faction territory overlays, clean technical aesthetic",
    horror: "weathered map with damage, water stains, uncertain coastlines, some regions marked UNKNOWN or void, erratic handwriting, disturbing details in margins",
    postapoc: "damaged pre-war map covered in survival annotations, torn edges, different colored inks added over time, some regions marked with radiation/danger symbols"
  }
  return `Create a ${styleGuide[world.narrativeTone]} for a world called "${world.worldName}". 
  It has: ${world.geography.map(r => r.name).join(', ')} as major regions.
  Style: ${world.genre} tone. No text overlaid ‚Äî map art only, labels will be added separately.`
}
```

#### Method B: SVG Procedural Render (Fully Interactive)
For worlds where we want click-to-explore behavior:

```typescript
// lib/map-renderer.ts
// Uses simplex-noise to generate terrain heightmap
// Renders to SVG with biome coloring
// Locations placed as interactive SVG elements
import { createNoise2D } from 'simplex-noise'

function generateWorldMapSVG(geography: GeographyData, style: MapStyle): string {
  const noise = createNoise2D()
  // ... generate terrain, coastlines, biomes
  // ... place regions at specified coordinates
  // ... add location markers
  // ... style per genre
}
```

#### Method C: Hybrid (Recommended)
1. Generate terrain via SVG procedural (fast, interactive, no cost)
2. Pass terrain description to `dall-e-3` ‚Üí get stylized overlay texture
3. Composite them: procedural structure + AI art style
4. Store both: SVG for interaction data, image for visual excellence

### Map Reveal Mechanic (Fog of War)

At world creation, only the **starting region** is revealed with details. Everything else is either:
- **Heard about** (named on map, no detail): "The Thornwood" ‚Äî you've heard of it, it's on your map as a shape
- **Unknown** (blank, no label): the far reaches of the world
- **Revealed** (visited): full detail, your notes, quest markers

As you explore, regions fill in. The map literally grows. This is stored in Supabase and updated on every significant travel event.

---

## LAYER 2: Regional Map

### What It Contains

When you enter a region (first time), Claude generates a regional description that includes a list of:
- Named towns and settlements (with rough population and purpose)
- Dungeons, ruins, sites of interest
- Wilderness landmarks (the black waterfall, the giant's tooth rock)
- Roads, paths, dangerous routes
- Faction borders and control zones

This becomes a **regional map** ‚Äî smaller scale, more detail.

```typescript
interface RegionalMap {
  regionId: string
  worldId: string

  // Layout data
  settlements: Settlement[]
  pointsOfInterest: PointOfInterest[]
  roads: Road[]
  wilderness: WildernessZone[]
  factionControl: FactionZone[]

  // Visual
  imageUrl: string
  style: RegionalMapStyle   // 'hand-drawn' | 'schematic' | 'satellite' | 'treasure-map'

  // Fog of War
  revealedLocations: string[]
  playerNotes: MapAnnotation[]
}

interface Settlement {
  id: string
  name: string
  type: 'village' | 'town' | 'city' | 'fortress' | 'outpost' | 'ruins'
  population: string         // "~200", "thousands", "abandoned"
  controlledBy: string       // Faction
  keyNPCs: string[]          // NPC IDs pre-assigned to this settlement
  services: string[]         // ["blacksmith", "inn", "temple", "magic shop"]
  questHooks: string[]       // Pre-generated quest seeds for this location
  mapPosition: { x: number; y: number }
}
```

### Generation: AI JSON ‚Üí Rendered Image

Claude generates the region in structured JSON during world exploration (not all upfront ‚Äî lazy loaded as you go). This JSON is:
1. Stored in Supabase as the RegionalMap record
2. Passed to image generation to create the visual map
3. Referenced for location generation when you visit specific spots

---

## LAYER 3: Location Map

### Town and City Maps

When you **enter a settlement for the first time**, Claude generates its layout:
- District breakdown (merchant quarter, docks, temple district, slums, noble estates)
- Key buildings with names
- Street character (cramped alleys, grand boulevards, hidden passages)
- Entrance/exit points
- Points of ongoing narrative interest ("the inn where the rumors are," "the smith who knows something")

**Rendered as:** Watabou-style top-down illustration. We generate this via `gpt-image-1` with a detailed style prompt:

```typescript
const townMapPrompt = (settlement: Settlement, worldStyle: MapStyle): string => {
  const styleMap = {
    'hand-drawn': "medieval fantasy top-down city map, detailed ink illustration, street lines, building footprints labeled, districts marked, by a skilled cartographer",
    'schematic': "futuristic colony schematic, top-down blueprint view, modules and corridors labeled, utilitarian design",
    'treasure-map': "old treasure map style, rough hand-drawn, X marks key locations, directional notes in margins, aged parchment"
  }
  return `${styleMap[worldStyle]} for a ${settlement.type} called "${settlement.name}". 
  It has these districts: ${settlement.districts?.join(', ')}. 
  Population: ${settlement.population}. 
  Style: ${worldStyle === 'hand-drawn' ? 'D&D module map' : 'genre-appropriate'}.`
}
```

**Town map is NOT navigated with WASD.** It is a **reference artifact** ‚Äî like the map insert in an old D&D module. You look at it to orient yourself, then interact via text. The DM knows layout. When you say "I go to the docks," the DM knows where the docks are relative to where you are.

### Dungeon/Ruin Maps

Same principle but different layout generation:
- Room-by-room structure
- Vertical as well as horizontal (dungeon levels)
- Purpose-built vs organic (a built dungeon has symmetry and intention; a natural cave is organic)
- Thematic zones (the prison level, the cultist chamber, the treasury)

---

## LAYER 4: Area Map (Dungeon Generation)

This is the biggest and most technically interesting map layer. In TTRPG, this is the **grid mat**. In video game terms, this is the level design. It needs to be:

1. Generated procedurally (so no two dungeons are alike)
2. Narratively coherent (this dungeon makes sense as a place)
3. Revealed room by room (fog of war)
4. Rendered beautifully (Dyson Logos / OSR aesthetic)

### Dungeon Types and Generation Algorithm per Type

```typescript
type DungeonType =
  | 'built-dungeon'       // Constructed by intelligent beings ‚Äî rooms are purposeful
  | 'natural-cave'        // Organic, flowing passages, caverns
  | 'ruined-building'     // Once a building, now partially collapsed
  | 'tomb-complex'        // Ritual purpose, maze-like, traps likely
  | 'fortress-interior'   // Military design ‚Äî guard posts, barracks, throne rooms
  | 'mine'                // Linear with branches, utility rooms
  | 'magical-space'       // Physics may be irregular, non-Euclidean possible
  | 'spaceship-interior'  // (Sci-Fi) Corridors, bulkheads, compartments
  | 'space-station'       // (Sci-Fi) Hub + spoke layout
  | 'haunted-house'       // Victorian horror, floors, rooms, secrets
```

#### Built Dungeon Algorithm (Primary Fantasy Generator)

Based on the classic Rooms & Mazes approach, adapted for our UI:

```typescript
interface DungeonLayout {
  id: string
  questId: string
  type: DungeonType
  theme: string           // "orcish war camp", "ancient elven tomb", "aberration nest"
  floors: DungeonFloor[]
  totalRooms: number
  seed: number            // For reproducibility
  generatedAt: Date
}

interface DungeonFloor {
  floorNumber: number
  rooms: DungeonRoom[]
  corridors: Corridor[]
  entrance: { roomId: string; direction: string }
  exit?: { roomId: string; direction: string; leadsTo: string }
  specialFeatures: DungeonFeature[]
}

interface DungeonRoom {
  id: string
  name: string            // AI-generated: "The Charnel Hall", "Guard Post Alpha"
  shape: 'rectangular' | 'circular' | 'irregular' | 'L-shaped' | 'T-shaped'
  dimensions: { width: number; height: number }  // In feet (5ft grid)
  position: { x: number; y: number }             // Grid coordinates
  connections: RoomConnection[]

  // Contents (generated by Claude, keyed to theme)
  description: string     // AI narrative description
  enemies?: EnemyGroup
  loot?: LootTable
  traps?: TrapInstance[]
  secrets?: SecretFeature[]
  puzzle?: Puzzle
  ambiance: string        // "The smell of old blood. Chains hang from the ceiling."

  // Fog of war
  revealed: boolean
  visited: boolean
  playerNotes: string
}

interface RoomConnection {
  targetRoomId: string
  type: 'door' | 'open-arch' | 'secret-door' | 'portcullis' | 'collapsed-partial' | 'locked-door' | 'magical-barrier'
  direction: 'north' | 'south' | 'east' | 'west' | 'up' | 'down'
  locked: boolean
  trapped: boolean
  description: string    // "A heavy oak door bound with iron"
}
```

#### The Generation Process (Step by Step)

```
1. SEED the generator with (dungeonId + characterId) ‚Üí same inputs = same dungeon always

2. THEME creation:
   - Claude receives: quest context, faction that built this, world tone, dungeon type
   - Generates: named theme, 3-5 "signature elements" of this specific dungeon
   - Example: "The Tomb of the Last Warlord: signature elements are ceremonial weapon racks,
     crumbling ancestor shrines, hollow-eyed stone guardians, green alchemical flames,
     the smell of centuries of incense gone rancid"

3. FLOOR LAYOUT generation (algorithmic, not AI):
   - Place rooms using BSP (Binary Space Partition) approach
   - Guaranteed connected graph (spanning tree + loops)
   - No isolated rooms
   - Size configuration: small (5-8 rooms) / medium (10-18 rooms) / large (20-35 rooms)
   - 1-3 floors depending on quest scope

4. ROOM NAMING & DESCRIPTION (Claude, batched):
   - Send all room positions + theme to Claude Haiku
   - Returns: name, description, ambiance for each room
   - This is a batch call ‚Äî one call, all rooms at once
   - Rooms categorized: entrance, junction, encounter, treasure, boss, secret

5. ENCOUNTER PLACEMENT (Claude Sonnet):
   - Enemy placement follows dungeon logic (guards near entrance, boss at end)
   - Traps guarding treasure, puzzles at major transitions
   - Loot distributed: higher quality deeper in

6. RENDER to SVG/Canvas:
   - Room rectangles drawn with grid overlay (5ft squares)
   - Walls as thick lines, doors as gaps with door symbols
   - Hatching on walls (Dyson Logos style)
   - Room numbers for reference
   - Fog of war overlay (unrevealed rooms are black)
   - Current room highlighted
```

#### Natural Cave Algorithm (Cellular Automata)

For organic cave systems:

```typescript
function generateCaveSystem(width: number, height: number, seed: number): boolean[][] {
  // 1. Initialize with random noise
  let grid = initRandom(width, height, seed, fillProbability = 0.45)

  // 2. Apply cellular automata rules (5 iterations)
  for (let i = 0; i < 5; i++) {
    grid = applyCellularAutomata(grid, birthLimit = 4, deathLimit = 3)
  }

  // 3. Remove isolated caves (flood fill connectivity check)
  grid = ensureConnectivity(grid)

  // 4. Place cave features: chambers, underground lakes, crystal formations
  return grid
}
```

Visual style: organic, rough edges, no straight walls, cavern chambers connected by narrow passages.

### Room-by-Room Reveal (The TTRPG Experience)

When the player enters a room, the fog of war lifts:

1. The room `revealed` flag flips to `true` in Supabase
2. The SVG map re-renders with that room visible
3. Claude narrates the room description (from the stored `description` field)
4. Enemies / items / traps trigger based on flags
5. Player adds notes to their map if desired

This means entering a new room always triggers:
```
"You push open the heavy iron door..."
[MAP UPDATE: Room 7 "The Warlord's Chamber" revealed]
[SVG re-renders with Room 7 unfogged]

‚Üí DESCRIPTION: Torchlight reveals a cavernous throne room...
‚Üí ENCOUNTER: 3 Tomb Guardians animate...
```

### Multi-Level Dungeons

Stairs, ladders, pits, teleporters connect floors:

```typescript
interface FloorTransition {
  fromFloor: number
  toFloor: number
  type: 'stairs-down' | 'stairs-up' | 'pit' | 'ladder' | 'elevator' | 'telepad' | 'portal'
  fromRoomId: string
  toRoomId: string
  description: string
}
```

Each floor has its own map. The UI shows which floor you're on with a floor selector.

---

## LAYER 5: Tactical Combat Map

### The TTRPG Grid

In tabletop, the DM says "grab the grid mat" and places miniatures. That tactile experience translates to:

**A rendered grid-based tactical map** generated when combat begins. Not just the enemy list ‚Äî an actual visual battlefield.

```typescript
interface TacticalMap {
  combatId: string
  location: string           // "inside the tomb chamber", "tavern common room", "forest clearing"
  description: string        // Claude's narrative description of the battlefield

  // Grid
  grid: TacticalCell[][]    // [y][x] grid of cells
  gridSize: { width: number; height: number }  // in 5ft squares
  scale: '5ft' | '10ft'     // per grid square

  // Terrain features
  terrain: TerrainFeature[]

  // Entity positions (updated each round)
  playerPosition: { x: number; y: number }
  partyPositions: { memberId: string; x: number; y: number }[]
  enemyPositions: { enemyId: string; x: number; y: number }[]

  // Visual
  backgroundImageUrl?: string  // Optional: AI-generated battlefield art
  renderStyle: 'grid' | 'narrative' | 'both'
}

interface TacticalCell {
  x: number
  y: number
  terrain: 'open' | 'wall' | 'difficult' | 'cover-half' | 'cover-full' | 'hazard' | 'water' | 'chasm'
  elevation: number          // 0 = ground, positive = raised
  feature?: TacticalFeature   // Brazier, barrel, pillar, etc.
  occupied?: string           // entity ID if occupied
}

interface TacticalFeature {
  id: string
  name: string               // "Oil Barrel", "Chandelier", "Brazier", "Pillar"
  isDestructible: boolean
  isInteractable: boolean
  interactionDescription: string  // "Kick over for 2d6 fire damage in 10ft radius"
  currentState: 'intact' | 'damaged' | 'destroyed' | 'triggered'
  imageSymbol: string        // Emoji or icon for grid rendering: "ü™î" "üõ¢Ô∏è" "üíé"
}
```

### Tactical Map Rendering

The tactical map renders inline in the combat UI. It is not a separate screen ‚Äî it floats alongside the narrative text:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  TACTICAL VIEW ‚Äî THRONE ROOM    ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  ü™®ü™®ü™®ü™®ü™®ü™®ü™®ü™®ü™®ü™®ü™®ü™®  ‚îÇ
‚îÇ  ü™®   üé≠        üî•    ü™®  ‚îÇ
‚îÇ  ü™®     YOU  ‚éØ‚éØ‚éØ‚éØGRD   ü™®  ‚îÇ
‚îÇ  ü™®   PIP‚Üë      ORK2   ü™®  ‚îÇ
‚îÇ  ü™® LYRA  THOR  ORK3   ü™®  ‚îÇ
‚îÇ  ü™®ü™®ü™®ü™®ü™®ü™®ü™®ü™®üö™ü™®ü™®ü™®  ‚îÇ
‚îÇ                                 ‚îÇ
‚îÇ  YOU: High Ground (+2 ATK)      ‚îÇ
‚îÇ  üî• Brazier: interactive        ‚îÇ
‚îÇ  üö™ Exit: SE corner             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**For players who prefer text-only**: Toggle the tactical view off. Combat works identically ‚Äî just no visual grid.

**For players who want FULL tactical**: Interactive SVG grid where you can click to submit movement/targeting.

### Battlefield Generation

At combat start, Claude generates a description of the battlefield. This is parsed into `TacticalCell` data:

```typescript
// Prompt to Claude Sonnet:
// "Given this location [{description}] and combat context [{context}],
//  generate a tactical battlefield as JSON with: 
//  grid dimensions, terrain features, 2-4 interactive environmental elements,
//  recommended starting positions for player and enemies."
//
// Returns: TacticalMapData with cells and features pre-populated
```

For theater-of-the-mind players, this battlefield data informs the combat descriptions:
> "The Orc Warrior is 10 feet to your left ‚Äî you have flanking advantage with Pip behind it. The chandelier hangs overhead."

Even if they never look at the grid, the spatial data makes AI narration more precise and meaningful.

---

## Map Storage Architecture

```
Supabase Tables:
  world_maps        ‚Äî Layer 1: one per world
  regional_maps     ‚Äî Layer 2: one per region
  location_maps     ‚Äî Layer 3: one per town/dungeon
  dungeon_floors    ‚Äî Layer 4: one per floor
  tactical_maps     ‚Äî Layer 5: one per combat encounter (retained for replay)

Supabase Storage:
  /rpg-images
    /maps
      /world/{worldId}/world-map.webp
      /maps/regional/{regionId}/region-map.webp
      /maps/locations/{locationId}/location-map.webp
      /maps/dungeons/{dungeonId}/floor-{n}-clean.webp    ‚Üê no fog
      /maps/dungeons/{dungeonId}/floor-{n}-fogged.webp   ‚Üê with fog (updates)
      /maps/tactical/{combatId}/battlefield.webp
```

---

## Map Styles by World Genre

| World Type | World Map Style | Region Style | Dungeon Style | Tactical Style |
|------------|----------------|--------------|---------------|----------------|
| Classic Fantasy | Tolkien parchment | OSR ink illustration | Dyson Logos grid hatch | D&D grid mat |
| Dark Fantasy | Scarred vellum | Heavy ink, blood stains | Dark stone, no decoration | Grim stone grid |
| Sci-Fi | Stellar cartography | Sector schematic | Spaceship blueprint | HUD overlay |
| Horror | Disturbed, wrong proportions | Uncertain, incomplete | Unstable, shifting | (Horror prefers no tactical ‚Äî disorientation) |
| Cyberpunk | Neural network map | City sector overlay | Facility blueprint | AR overlay |
| Post-Apocalypse | Ruined pre-war map | Survivor hand-notes | Collapsed ruins | Rubble grid |
| Mythological | Ancient scroll painting | Illuminated manuscript | Temple diagram | Ritual space |
| Steampunk | Mechanical line art | Expedition survey map | Gear-cluttered blueprints | Workshop grid |

---

## The Map as Journal Artifact

### Player Map Notes

At any time, the player can **annotate their maps**:
- Click any revealed room/location ‚Üí add note
- Notes persist in Supabase with the character
- Examples: "Orc camp here ‚Äî avoid", "The merchant lied about this road", "Hidden stash in NW corner"
- Notes have a date (in-world calendar) so you remember when you wrote them

### Map Discovery Events

Maps can be found as in-game items:
- **Partial dungeon maps**: Shows some of the dungeon layout, rooms revealed without visiting
- **Treasure maps**: An X on a regional map, quest tied to location
- **Old maps**: May be wrong, outdated, misleading ‚Äî narrative tension
- **Enemy maps**: Looting a scout's pouch ‚Üí get their operational map showing enemy positions
- **Cartographer's commissions**: Pay an NPC to map a region you've explored

### Map as Quest Proof

Some quests require a map:
- "We need you to survey the forbidden ruins and return with a complete map"
- The player's exploration and fog-of-war state **is** the quest completion tracker
- Dungeon fully revealed = survey complete

---

## Technical Implementation Stack

### Noise Library
```
npm install simplex-noise alea
```
- `simplex-noise` ‚Äî TypeScript-native Simplex noise (no C bindings needed)
- `alea` ‚Äî Seeded PRNG so worlds are reproducible

### SVG Rendering
- World map / regional map: SVG generated server-side via `lib/map-renderer.ts`
- Dungeon maps: SVG components in React, updated as rooms reveal
- Tactical maps: Canvas 2D API for performance (60fps updates during combat)

### Key Libraries
```
npm install simplex-noise          // Terrain generation
npm install alea                   // Seeded random number generation
npm install @napi-rs/canvas        // Server-side canvas rendering (Vercel compatible)
```

### Map Generation Routes

```
POST /api/maps/world-genesis       // Generate world map data + image at character creation
POST /api/maps/region              // Generate region map on first visit
POST /api/maps/location            // Generate location map (town/dungeon) on first entry
POST /api/maps/dungeon-floor       // Generate next dungeon floor
POST /api/maps/reveal-room         // Reveal a room (fog of war update)
POST /api/maps/tactical            // Generate tactical battlefield at combat start
GET  /api/maps/{characterId}       // Get all map data for a character
PATCH /api/maps/annotate           // Add player note to map
```

---

## Decisions Still Open (Need to Decide)

| Question | Option A | Option B | Recommendation |
|----------|----------|----------|----------------|
| World map source | AI image gen (`gpt-image-1`) | Procedural SVG | Start with SVG, upgrade to AI blend later |
| Dungeon render style | SVG (interactive) | AI image (pretty) | SVG ‚Äî fog of war requires interaction |
| Tactical map default | Always show | Toggle off by default | Show by default, easy to close |
| Map annotation UX | Click cell ‚Üí type note | Voice note ‚Üí transcribed | Click to type |
| Multi-floor navigation | Floor selector tab | Minimap in corner | Floor selector tab |
| Dungeon size limits | Room count cap | Time/depth cap | Room count: max 35 per floor |
| Map found as items | Yes ‚Äî full loot type | No ‚Äî too complex | Yes ‚Äî great narrative texture |
| Player draws on map | Yes (freehand) | Notes only | Notes only (MVP), freehand later |

---

## The Complete TTRPG Map Experience

Here is the moment-by-moment player experience matched to TTRPG equivalents:

```
CHARACTER CREATION
  TTRPG: DM reveals the campaign world map across the table
  THIS GAME: World map image loads alongside the character's world in the Journal

FIRST SESSION
  TTRPG: Party starts in a village, DM describes surroundings
  THIS GAME: Regional map of the starting area is shown ‚Äî most of it is fog

EXPLORATION
  TTRPG: "You travel north for two days and reach the forest's edge"
  THIS GAME: Travel narrative ‚Üí regional map updates, roads revealed, forest edge marked

FIRST DUNGEON
  TTRPG: DM places dungeon map face-down, reveals rooms as you enter
  THIS GAME: Dungeon map loads fully fogged, rooms reveal as you enter

COMBAT
  TTRPG: Grid mat comes out, minis placed, DM describes terrain
  THIS GAME: Tactical grid loads with your position and enemies shown

ITEM FOUND
  TTRPG: "The orc was carrying a partial map of the mine's second level"
  THIS GAME: Partial dungeon map item ‚Üí some rooms pre-revealed (but not visited)

CAMPAIGN END
  TTRPG: Players keep the campaign maps as souvenirs
  THIS GAME: Full world map export as PDF ‚Äî a record of everywhere you went
```

---

## Reference Resources Researched

- **redblobgames.com** ‚Äî Noise-based terrain generation; elevation + moisture ‚Üí biomes; Voronoi polygon maps
- **stuffwithstuff.com** ‚Äî "Rooms and Mazes" algorithm: place rooms, fill with mazes, prune dead ends
- **roguebasin.com** ‚Äî Classic dungeon building algorithm: grow from initial room, reject overlaps
- **watabou.itch.io** ‚Äî Local symmetry dungeon generator; partly symmetrical = feels human-made
- **azgaar.github.io** ‚Äî Fantasy Map Generator: Voronoi + noise for full world maps (open source!)
- **simplex-noise.js** ‚Äî TypeScript library, returns -1 to +1, perfect for terrain
- **FastNoiseLite** ‚Äî Available as JavaScript/TypeScript, many noise types including Voronoi
